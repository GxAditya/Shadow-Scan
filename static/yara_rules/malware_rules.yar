// ============================
// BASIC MALWARE DETECTION
// ============================

rule EICAR_Test_File {
    meta:
        description = "Detects the EICAR test string"
        author = "Shadow-Scan"
        severity = "high"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*" ascii
    condition:
        $eicar
}

rule SuspiciousPE {
    meta:
        description = "Detects suspicious PE characteristics"
        severity = "medium"
    strings:
        $s1 = "LoadLibraryA" ascii wide
        $s2 = "VirtualAlloc" ascii wide
        $s3 = "CreateRemoteThread" ascii wide
        $pdb = ".pdb" ascii
    condition:
        uint16(0) == 0x5A4D and
        2 of ($s*) and
        not $pdb
}

// ============================
// RANSOMWARE DETECTION
// ============================

rule PotentialRansomware {
    meta:
        description = "Detects potential ransomware indicators"
        severity = "high"
    strings:
        $encrypt1 = "encrypt" nocase ascii wide
        $encrypt2 = "AES" ascii wide
        $encrypt3 = "RSA" ascii wide
        $ransom = "ransom" nocase ascii wide
        $bitcoin = "bitcoin" nocase ascii wide
    condition:
        2 of ($encrypt*) and
        any of ($ransom, $bitcoin)
}

rule Ransomware_FileEncryption {
    meta:
        description = "Detects ransomware file encryption patterns"
        severity = "high"
    strings:
        $crypt1 = "CryptEncrypt" ascii wide
        $crypt2 = "CryptDecrypt" ascii wide
        $file1 = "FindFirstFile" ascii wide
        $file2 = "FindNextFile" ascii wide
        $ext1 = ".encrypted" ascii wide
        $ext2 = ".locked" ascii wide
        $ext3 = ".crypto" ascii wide
        $note1 = "README" nocase ascii wide
        $note2 = "HOW_TO_DECRYPT" nocase ascii wide
        $note3 = "DECRYPT_INSTRUCTION" nocase ascii wide
    condition:
        uint16(0) == 0x5A4D and
        (1 of ($crypt*)) and
        (1 of ($file*)) and
        (1 of ($ext*) or 1 of ($note*))
}

rule Ransomware_Payment {
    meta:
        description = "Detects ransomware payment indicators"
        severity = "high"
    strings:
        $btc1 = "bitcoin" nocase ascii wide
        $btc2 = "BTC" ascii wide
        $pay1 = "payment" nocase ascii wide
        $pay2 = "wallet" nocase ascii wide
        $dark1 = ".onion" ascii wide
        $dark2 = "tor browser" nocase ascii wide
    condition:
        2 of ($btc*) or
        (1 of ($btc*) and 1 of ($pay*)) or
        (1 of ($dark*) and 1 of ($pay*))
}

// ============================
// TROJAN / BACKDOOR DETECTION
// ============================

rule Trojan_RemoteAccess {
    meta:
        description = "Detects remote access trojan (RAT) characteristics"
        severity = "high"
    strings:
        $net1 = "WSAStartup" ascii wide
        $net2 = "connect" ascii wide
        $net3 = "send" ascii wide
        $net4 = "recv" ascii wide
        $shell1 = "cmd.exe" ascii wide
        $shell2 = "powershell" nocase ascii wide
        $exec1 = "CreateProcess" ascii wide
        $exec2 = "ShellExecute" ascii wide
        $reg1 = "RegSetValue" ascii wide
        $reg2 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        3 of ($net*) and
        (1 of ($shell*) or 1 of ($exec*)) and
        1 of ($reg*)
}

rule Backdoor_NetworkActivity {
    meta:
        description = "Detects backdoor network communication patterns"
        severity = "high"
    strings:
        $socket1 = "socket" ascii wide
        $socket2 = "WSASocket" ascii wide
        $bind = "bind" ascii wide
        $listen = "listen" ascii wide
        $accept = "accept" ascii wide
        $reverse = "connect" ascii wide
        $port1 = "4444" ascii wide
        $port2 = "31337" ascii wide
        $port3 = "1337" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        (1 of ($socket*)) and
        (($bind and $listen and $accept) or $reverse) and
        any of ($port*)
}

// ============================
// CRYPTOMINER DETECTION
// ============================

rule CryptoMiner {
    meta:
        description = "Detects cryptocurrency mining malware"
        severity = "high"
    strings:
        $mine1 = "stratum+tcp" ascii wide
        $mine2 = "xmrig" nocase ascii wide
        $mine3 = "minergate" nocase ascii wide
        $mine4 = "nicehash" nocase ascii wide
        $coin1 = "monero" nocase ascii wide
        $coin2 = "ethereum" nocase ascii wide
        $pool1 = "pool" nocase ascii wide
        $worker = "worker" nocase ascii wide
        $hashrate = "hashrate" nocase ascii wide
        $difficulty = "difficulty" nocase ascii wide
    condition:
        2 of ($mine*) or
        (1 of ($mine*) and 1 of ($coin*)) or
        (1 of ($coin*) and 2 of ($pool1, $worker, $hashrate, $difficulty))
}

rule CryptoMiner_API {
    meta:
        description = "Detects crypto mining API usage"
        severity = "medium"
    strings:
        $api1 = "CryptAcquireContext" ascii wide
        $api2 = "CryptCreateHash" ascii wide
        $api3 = "CryptHashData" ascii wide
        $cpu1 = "GetSystemInfo" ascii wide
        $cpu2 = "GetProcessorInformation" ascii wide
        $thread = "CreateThread" ascii wide
        $high_cpu = "SetThreadPriority" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        2 of ($api*) and
        1 of ($cpu*) and
        ($thread and $high_cpu)
}

// ============================
// KEYLOGGER / SPYWARE DETECTION
// ============================

rule Keylogger {
    meta:
        description = "Detects keylogger behavior"
        severity = "high"
    strings:
        $hook1 = "SetWindowsHookEx" ascii wide
        $hook2 = "GetAsyncKeyState" ascii wide
        $hook3 = "GetKeyState" ascii wide
        $hook4 = "GetKeyboardState" ascii wide
        $key1 = "VK_" ascii wide
        $log1 = "log" nocase ascii wide
        $file1 = "CreateFile" ascii wide
        $file2 = "WriteFile" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        1 of ($hook*) and
        ($key1 or 1 of ($log1)) and
        1 of ($file*)
}

rule Spyware_DataExfiltration {
    meta:
        description = "Detects spyware data exfiltration patterns"
        severity = "high"
    strings:
        $screen1 = "GetDC" ascii wide
        $screen2 = "BitBlt" ascii wide
        $screen3 = "CreateCompatibleBitmap" ascii wide
        $clip1 = "GetClipboardData" ascii wide
        $clip2 = "OpenClipboard" ascii wide
        $net1 = "InternetOpen" ascii wide
        $net2 = "HttpSendRequest" ascii wide
        $net3 = "FtpPutFile" ascii wide
        $file1 = "GetUserName" ascii wide
        $file2 = "GetComputerName" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        (2 of ($screen*) or 1 of ($clip*)) and
        1 of ($net*) and
        1 of ($file*)
}

// ============================
// WORM / VIRUS DETECTION
// ============================

rule Worm_NetworkSpread {
    meta:
        description = "Detects worm network spreading behavior"
        severity = "high"
    strings:
        $net1 = "WNetAddConnection" ascii wide
        $net2 = "WNetEnumResource" ascii wide
        $smb1 = "\\\\." ascii wide
        $smb2 = "IPC$" ascii wide
        $copy1 = "CopyFile" ascii wide
        $copy2 = "MoveFile" ascii wide
        $share1 = "NetShareEnum" ascii wide
        $share2 = "NetShareAdd" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        1 of ($net*) and
        (1 of ($smb*) or 1 of ($share*)) and
        1 of ($copy*)
}

rule Virus_FileInfection {
    meta:
        description = "Detects file infection virus patterns"
        severity = "high"
    strings:
        $find1 = "FindFirstFile" ascii wide
        $find2 = "FindNextFile" ascii wide
        $open = "CreateFile" ascii wide
        $write = "WriteFile" ascii wide
        $map1 = "CreateFileMapping" ascii wide
        $map2 = "MapViewOfFile" ascii wide
        $exe1 = ".exe" ascii wide
        $exe2 = ".dll" ascii wide
        $exe3 = ".scr" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        1 of ($find*) and
        ($open and $write) and
        1 of ($map*) and
        1 of ($exe*)
}

// ============================
// ROOTKIT DETECTION
// ============================

rule Rootkit_DriverLoading {
    meta:
        description = "Detects rootkit driver loading patterns"
        severity = "high"
    strings:
        $drv1 = "CreateService" ascii wide
        $drv2 = "StartService" ascii wide
        $drv3 = "OpenSCManager" ascii wide
        $kernel1 = "\\\\.\\Global" ascii wide
        $kernel2 = "ZwLoadDriver" ascii wide
        $kernel3 = "NtLoadDriver" ascii wide
        $sys = ".sys" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        2 of ($drv*) and
        (1 of ($kernel*) or $sys)
}

rule Rootkit_HookingAPIs {
    meta:
        description = "Detects API hooking behavior common in rootkits"
        severity = "high"
    strings:
        $hook1 = "VirtualProtect" ascii wide
        $hook2 = "WriteProcessMemory" ascii wide
        $hook3 = "ReadProcessMemory" ascii wide
        $nt1 = "NtQuerySystemInformation" ascii wide
        $nt2 = "NtQueryDirectoryFile" ascii wide
        $nt3 = "NtSetInformationThread" ascii wide
        $hide1 = "ZwSetSystemInformation" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        2 of ($hook*) and
        2 of ($nt*, $hide1)
}

// ============================
// WEB SHELL DETECTION
// ============================

rule WebShell_PHP {
    meta:
        description = "Detects PHP web shells"
        severity = "high"
    strings:
        $php = "<?php" ascii
        $eval1 = "eval" nocase ascii
        $eval2 = "assert" nocase ascii
        $exec1 = "exec" nocase ascii
        $exec2 = "shell_exec" nocase ascii
        $exec3 = "system" nocase ascii
        $exec4 = "passthru" nocase ascii
        $input1 = "$_GET" ascii
        $input2 = "$_POST" ascii
        $input3 = "$_REQUEST" ascii
        $base64 = "base64_decode" nocase ascii
    condition:
        $php and
        (1 of ($eval*)) and
        (1 of ($exec*)) and
        (1 of ($input*) or $base64)
}

rule WebShell_ASPX {
    meta:
        description = "Detects ASPX web shells"
        severity = "high"
    strings:
        $aspx1 = "<%@" ascii
        $aspx2 = "Page Language" nocase ascii
        $eval = "eval" nocase ascii
        $exec1 = "ProcessStartInfo" ascii
        $exec2 = "Process.Start" ascii
        $cmd1 = "cmd.exe" ascii
        $cmd2 = "powershell" nocase ascii
        $request = "Request" ascii
    condition:
        1 of ($aspx*) and
        ($eval or 1 of ($exec*)) and
        (1 of ($cmd*) or $request)
}

rule WebShell_JSP {
    meta:
        description = "Detects JSP web shells"
        severity = "high"
    strings:
        $jsp = "<%@" ascii
        $runtime1 = "Runtime.getRuntime" ascii
        $runtime2 = ".exec" ascii
        $process = "ProcessBuilder" ascii
        $cmd = "cmd" nocase ascii
        $request = "request.getParameter" ascii
    condition:
        $jsp and
        (($runtime1 and $runtime2) or $process) and
        ($cmd or $request)
}

// ============================
// DOCUMENT MALWARE DETECTION
// ============================

rule EnhancedSuspiciousDocument {
    meta:
        description = "Detects suspicious office documents with enhanced checks"
        author = "Shadow-Scan"
        severity = "high"
    strings:
        // Keywords often found in malicious macros or scripts
        $macro_auto = "AutoOpen" nocase wide ascii
        $macro_auto2 = "AutoExec" nocase wide ascii
        $macro_auto3 = "AutoClose" nocase wide ascii
        $macro_doc = "Document_Open" nocase wide ascii
        $macro_doc2 = "Document_Close" nocase wide ascii
        $powershell = "powershell" nocase wide ascii
        $cmd_exe = "cmd.exe" nocase wide ascii
        $vbscript = "vbscript" nocase wide ascii
        $javascript = "javascript" nocase wide ascii
        $wscript = "WScript.Shell" nocase wide ascii
        $msxml = "MSXML2.XMLHTTP" nocase wide ascii
        $adodb = "ADODB.Stream" nocase wide ascii
        $download = "DownloadFile" nocase wide ascii
        $execute = "Shell.Application" nocase wide ascii
        $createobject = "CreateObject" nocase wide ascii
        $getobject = "GetObject" nocase wide ascii
        $run_command = "Run" nocase wide ascii

        // Embedded object indicators
        $embedded_object = "ObjectPool" nocase wide ascii

        // Suspicious URL patterns
        $http = "http://" nocase wide ascii
        $https = "https://" nocase wide ascii

    condition:
        (uint32(0) == 0xE011CFD0 or uint32(0) == 0x04034B50) and
        (
            any of ($macro_*) or
            (1 of ($powershell, $cmd_exe, $vbscript, $javascript, $wscript, $msxml, $adodb, $execute, $createobject, $getobject, $run_command)) or
            ($embedded_object and 1 of ($powershell, $cmd_exe, $vbscript, $javascript, $wscript)) or
            (2 of ($download, $http, $https, $execute))
        )
}

rule MaliciousPDF {
    meta:
        description = "Detects malicious PDF documents"
        severity = "high"
    strings:
        $pdf = "%PDF" ascii
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $aa = "/AA" ascii
        $openaction = "/OpenAction" ascii
        $launch = "/Launch" ascii
        $embed = "/EmbeddedFile" ascii
        $objstm = "/ObjStm" ascii
        $exec1 = "exec" nocase ascii
        $exec2 = "importDataObject" ascii
    condition:
        $pdf at 0 and
        (1 of ($js*) or $aa or $openaction or $launch) and
        (1 of ($exec*) or $embed or $objstm)
}

// ============================
// FILELESS MALWARE INDICATORS
// ============================

rule Fileless_PowerShell {
    meta:
        description = "Detects fileless PowerShell attack indicators"
        severity = "high"
    strings:
        $ps1 = "powershell" nocase ascii wide
        $encoded = "-enc" nocase ascii wide
        $encoded2 = "-encodedcommand" nocase ascii wide
        $bypass = "-ExecutionPolicy Bypass" nocase ascii wide
        $hidden = "-WindowStyle Hidden" nocase ascii wide
        $download1 = "DownloadString" ascii wide
        $download2 = "DownloadFile" ascii wide
        $download3 = "Net.WebClient" ascii wide
        $iex = "IEX" ascii wide
        $invoke = "Invoke-Expression" ascii wide
    condition:
        $ps1 and
        (1 of ($encoded*) or $bypass or $hidden) and
        (1 of ($download*) or $iex or $invoke)
}

rule Fileless_WMI {
    meta:
        description = "Detects WMI-based fileless malware"
        severity = "high"
    strings:
        $wmi1 = "Win32_Process" ascii wide
        $wmi2 = "winmgmts:" ascii wide
        $wmi3 = "ROOT\\CIMV2" ascii wide
        $create = "Create" ascii wide
        $ps = "powershell" nocase ascii wide
        $cmd = "cmd" nocase ascii wide
        $exec = "__EventFilter" ascii wide
    condition:
        2 of ($wmi*) and
        ($create and (1 of ($ps, $cmd, $exec)))
}

// ============================
// ANTI-ANALYSIS TECHNIQUES
// ============================

rule AntiDebug_Checks {
    meta:
        description = "Detects anti-debugging techniques"
        severity = "medium"
    strings:
        $debug1 = "IsDebuggerPresent" ascii wide
        $debug2 = "CheckRemoteDebuggerPresent" ascii wide
        $debug3 = "NtQueryInformationProcess" ascii wide
        $debug4 = "OutputDebugString" ascii wide
        $debug5 = "FindWindow" ascii wide
        $debugstr1 = "ollydbg" nocase ascii wide
        $debugstr2 = "windbg" nocase ascii wide
        $debugstr3 = "x64dbg" nocase ascii wide
        $debugstr4 = "ida" nocase ascii wide
    condition:
        uint16(0) == 0x5A4D and
        (2 of ($debug*) or 1 of ($debugstr*))
}

rule AntiVM_Detection {
    meta:
        description = "Detects anti-VM techniques"
        severity = "medium"
    strings:
        $vm1 = "VMware" nocase ascii wide
        $vm2 = "VirtualBox" nocase ascii wide
        $vm3 = "VBOX" nocase ascii wide
        $vm4 = "QEMU" nocase ascii wide
        $vm5 = "Xen" nocase ascii wide
        $check1 = "HKEY_LOCAL_MACHINE\\HARDWARE" ascii wide
        $check2 = "SYSTEM\\ControlSet001\\Services\\Disk\\Enum" ascii wide
        $cpuid = "cpuid" ascii
    condition:
        uint16(0) == 0x5A4D and
        (2 of ($vm*) or (1 of ($check*) and $cpuid))
}

rule CodeInjection_Techniques {
    meta:
        description = "Detects code injection patterns"
        severity = "high"
    strings:
        $inject1 = "VirtualAllocEx" ascii wide
        $inject2 = "WriteProcessMemory" ascii wide
        $inject3 = "CreateRemoteThread" ascii wide
        $inject4 = "NtCreateThreadEx" ascii wide
        $inject5 = "RtlCreateUserThread" ascii wide
        $inject6 = "QueueUserAPC" ascii wide
        $process1 = "OpenProcess" ascii wide
        $process2 = "GetThreadContext" ascii wide
        $process3 = "SetThreadContext" ascii wide
    condition:
        uint16(0) == 0x5A4D and
        2 of ($inject*) and
        1 of ($process*)
}

// ============================
// OBFUSCATION DETECTION
// ============================

rule Obfuscated_Strings {
    meta:
        description = "Detects string obfuscation patterns"
        severity = "medium"
    strings:
        $xor = "xor" nocase ascii wide
        $decode1 = "base64" nocase ascii wide
        $decode2 = "FromBase64String" ascii wide
        $decode3 = "Convert.FromBase64" ascii wide
        $rot13 = "rot13" nocase ascii wide
    condition:
        3 of them
}

rule Packed_Executable {
    meta:
        description = "Detects packed executables"
        severity = "medium"
    strings:
        $upx = "UPX" ascii
        $aspack = "aPLib" ascii
        $mpress = ".MPRESS" ascii
        $pecompact = "PECompact" ascii
        $telock = "Telock" ascii
        $themida = "Themida" ascii
        $vmprotect = "VMProtect" ascii
    condition:
        uint16(0) == 0x5A4D and
        any of them
}
