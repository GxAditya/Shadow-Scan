rule SuspiciousPE {
    meta:
        description = "Detects suspicious PE characteristics"
        severity = "medium"
    strings:
        $s1 = "LoadLibraryA" ascii wide
        $s2 = "VirtualAlloc" ascii wide
        $s3 = "CreateRemoteThread" ascii wide
        $pdb = /\.pdb$/ 
    condition:
        uint16(0) == 0x5A4D and
        2 of ($s*) and
        not $pdb
}

rule PotentialRansomware {
    meta:
        description = "Detects potential ransomware indicators"
        severity = "high"
    strings:
        $encrypt1 = "encrypt" nocase ascii wide
        $encrypt2 = "AES" ascii wide
        $encrypt3 = "RSA" ascii wide
        $ransom = "ransom" nocase ascii wide
        $bitcoin = "bitcoin" nocase ascii wide
    condition:
        2 of ($encrypt*) and
        any of ($ransom, $bitcoin)
}

rule EnhancedSuspiciousDocument {
    meta:
        description = "Detects suspicious office documents with enhanced checks"
        author = "Trae AI"
        severity = "high"
    strings:
        // Common OLE/Office magic bytes
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 } // OLE Compound File
        $ooxml_magic = { 50 4B 03 04 } // OOXML (docx, xlsx, pptx)

        // Keywords often found in malicious macros or scripts
        $macro_exec = /Sub\s+Auto(?:Open|Exec|Close)\s*\(\)/ nocase wide ascii // Auto-executing macro names
        $macro_exec_alt = /Document(?:_Open|_Close)\s*\(\)/ nocase wide ascii
        $powershell = "powershell" nocase wide ascii
        $cmd_exe = "cmd.exe" nocase wide ascii
        $vbscript = "vbscript" nocase wide ascii
        $javascript = "javascript" nocase wide ascii
        $wscript = "WScript.Shell" nocase wide ascii
        $msxml = "MSXML2.XMLHTTP" nocase wide ascii
        $adodb = "ADODB.Stream" nocase wide ascii
        $download = "DownloadFile" nocase wide ascii
        $execute = "Shell.Application" nocase wide ascii // For executing commands
        $createobject = "CreateObject" nocase wide ascii
        $getobject = "GetObject" nocase wide ascii
        $run_command = "Run" nocase wide ascii // Common in WScript

        // Embedded object indicators
        $embedded_object = "ObjectPool" nocase wide ascii // Often contains embedded OLE objects
        $activex_control = /\{[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}\}/ nocase wide ascii // CLSIDs for ActiveX

        // Suspicious URL patterns (very generic, use with caution or refine)
        $http_url = /https?:\/\/[^\s"]+/ nocase wide ascii

    condition:
        (uint32(0) == 0xE011CFD0 or uint32(0) == 0x04034B50) and // Check for OLE or OOXML
        (
            1 of ($macro_exec, $macro_exec_alt) or
            (1 of ($powershell, $cmd_exe, $vbscript, $javascript, $wscript, $msxml, $adodb, $execute, $createobject, $getobject, $run_command)) or
            (1 of ($embedded_object, $activex_control) and 1 of ($powershell, $cmd_exe, $vbscript, $javascript, $wscript)) or
            (2 of ($download, $http_url, $execute))
        )
}

rule EICAR_Test_File {
    meta:
        description = "Detects the EICAR test string"
        author = "Trae AI"
        severity = "info"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*" ascii
    condition:
        $eicar
}

rule EICAR_Test_File {
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    condition:
        $eicar
}
